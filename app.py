# -*- coding: utf-8 -*-
"""emotion_analytics_app.ipynb

Automatically generated by Colab.

Original file is located at
Â  Â  https://colab.research.google.com/drive/1u_DW1CvVTqNbGpBkdqy70f3LTpyWx5Ma
"""

import streamlit as st
import cv2
from deepface import DeepFace
import pandas as pd
from datetime import datetime
from fpdf import FPDF
import plotly.express as px
import numpy as np
from PIL import Image

st.title("ğŸ˜Š Real-Time Emotion Detection & Analytics")

# Session state init
if 'run' not in st.session_state:
Â  Â  st.session_state.run = False
if 'data' not in st.session_state:
Â  Â  st.session_state.data = pd.DataFrame(columns=['Time', 'Emotion'])

# Start/Stop buttons
col1, col2 = st.columns(2)
if col1.button('Start Camera'):
Â  Â  st.session_state.run = True
if col2.button('Stop Camera'):
Â  Â  st.session_state.run = False

FRAME_WINDOW = st.image([])

# Emoji setup
emoji_map = {
Â  Â  'happy': 'emojis/happy.png',
Â  Â  'sad': 'emojis/sad.png',
Â  Â  'angry': 'emojis/angry.png',
Â  Â  'surprise': 'emojis/surprise.png',
Â  Â  'neutral': 'emojis/neutral.png',
Â  Â  'disgust': 'emojis/disgust.png',
Â  Â  'fear': 'emojis/fear.png'
}
emoji_images = {k: Image.open(v).convert("RGBA").resize((64, 64)) for k,v in emoji_map.items()}

# Start camera
camera = cv2.VideoCapture(0)
frame_count = 0
current_emotion = 'neutral'Â  # default

while st.session_state.run:
Â  Â  ret, frame = camera.read()
Â  Â  if not ret:
Â  Â  Â  Â  st.write("Failed to capture image")
Â  Â  Â  Â  break

Â  Â  frame_count += 1

Â  Â  # Analyze every 5th frame only
Â  Â  if frame_count % 5 == 0:
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  analysis = DeepFace.analyze(
Â  Â  Â  Â  Â  Â  Â  Â  frame,
Â  Â  Â  Â  Â  Â  Â  Â  actions=['emotion'],
Â  Â  Â  Â  Â  Â  Â  Â  enforce_detection=False,
Â  Â  Â  Â  Â  Â  Â  Â  detector_backend='opencv'Â  # lightweight
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  emotion = analysis[0]['dominant_emotion']
Â  Â  Â  Â  Â  Â  current_emotion = emotion

Â  Â  Â  Â  Â  Â  # Save to data
Â  Â  Â  Â  Â  Â  now = datetime.now().strftime("%H:%M:%S")
Â  Â  Â  Â  Â  Â  new_row = pd.DataFrame({'Time': [now], 'Emotion': [emotion]})
Â  Â  Â  Â  Â  Â  st.session_state.data = pd.concat([st.session_state.data, new_row], ignore_index=True)

Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  print(f"Detection error: {e}")

Â  Â  # Overlay text
Â  Â  cv2.putText(frame, f'{current_emotion}', (20, 50),
Â  Â  Â  Â  Â  Â  Â  Â  cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2, cv2.LINE_AA)

Â  Â  # Overlay emoji
Â  Â  emoji = emoji_images.get(current_emotion)
Â  Â  if emoji:
Â  Â  Â  Â  frame_pil = Image.fromarray(cv2.cvtColor(frame, cv2.COLOR_BGR2RGB))
Â  Â  Â  Â  frame_pil.paste(emoji, (frame_pil.width - 70, 10), emoji)
Â  Â  Â  Â  frame = cv2.cvtColor(np.array(frame_pil), cv2.COLOR_RGB2BGR)

Â  Â  # Show frame
Â  Â  frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
Â  Â  FRAME_WINDOW.image(frame)

camera.release()

# Analytics dashboard
if not st.session_state.data.empty:
Â  Â  st.subheader("ğŸ“Š Emotion Analytics Dashboard")

Â  Â  st.write(st.session_state.data)

Â  Â  counts = st.session_state.data['Emotion'].value_counts().reset_index()
Â  Â  counts.columns = ['Emotion', 'Count']

Â  Â  fig_bar = px.bar(counts, x='Emotion', y='Count', color='Emotion', title="Emotion Count")
Â  Â  st.plotly_chart(fig_bar)

Â  Â  fig_pie = px.pie(counts, names='Emotion', values='Count', title="Emotion Distribution")
Â  Â  st.plotly_chart(fig_pie)

Â  Â  fig_line = px.line(st.session_state.data, x='Time', y='Emotion', title="Emotion Timeline")
Â  Â  st.plotly_chart(fig_line)

Â  Â  dominant = counts.iloc[0]['Emotion']
Â  Â  st.success(f"ğŸ˜Š Dominant emotion detected: **{dominant}**")

Â  Â  csv = st.session_state.data.to_csv(index=False).encode()
Â  Â  st.download_button("â¬‡ï¸ Download CSV", csv, "emotion_data.csv", "text/csv")

Â  Â  if st.button("ğŸ“ Generate PDF Report"):
Â  Â  Â  Â  pdf = FPDF()
Â  Â  Â  Â  pdf.add_page()
Â  Â  Â  Â  pdf.set_font("Arial", size=12)
Â  Â  Â  Â  pdf.cell(200, 10, txt="Emotion Detection Session Report", ln=True, align='C')
Â  Â  Â  Â  for idx, row in st.session_state.data.iterrows():
Â  Â  Â  Â  Â  Â  pdf.cell(0, 10, f"{row['Time']}: {row['Emotion']}", ln=True)
Â  Â  Â  Â  pdf.output("emotion_report.pdf")
Â  Â  Â  Â  with open("emotion_report.pdf", "rb") as f:
Â  Â  Â  Â  Â  Â  st.download_button("â¬‡ï¸ Download PDF Report", f, "emotion_report.pdf")

st.caption("generated by pulak saha")
